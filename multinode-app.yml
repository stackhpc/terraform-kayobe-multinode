---

- hosts: localhost
  tasks:    
    - name: Show Playbook Directory
      debug:
       msg: "{{ playbook_dir }}"

    - name: Generate SSH Key
      command: ssh-keygen -t rsa -b 4096 -f "{{ playbook_dir }}/ssh_key" -q -N ""
      vars:
        ssh_key_path: "{{ playbook_dir }}"

    - name: Template Terraform files into project directory
      template:
        src: terraform.tfvars.j2
        dest: "{{ playbook_dir }}/terraform.tfvars"
  
    - name: Template Terraform userdata.cfg.tpl files into project template directory
      template:
        src: "{{ playbook_dir }}/templates/userdata.cfg.tpl.j2"
        dest: "{{ playbook_dir }}/templates/userdata.cfg.tpl"

# Provision the infrastructure
# The CaaS puts hosts for accessing the OpenStack API into the 'openstack' group
- hosts: openstack
  roles:
    - cluster_infra

# Write the outputs as the final task
- hosts: localhost
  tasks:
    - debug: var=outputs
      vars:
        outputs: 
          cluster_access_ip: "{{ hostvars[groups['openstack'][0]].cluster_gateway_ip }}"
    
    - name: Show Playbook Directory
      debug:
       msg: "{{ playbook_dir }}"

# Install the ansible requirements
- name: Install ansible requirements
  command: ansible-galaxy install -r ansible/requirements.yml

# Import the playbook to start configuring the multi-node hosts.
- name: Configure hosts and deploy ansible
  import_playbook: ansible/configure-hosts.yml